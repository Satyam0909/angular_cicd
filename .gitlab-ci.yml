image: docker:latest

services:
  - docker:dind

stages:
  - build
  # - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2

before_script:
  - docker info


build:
  stage: build
  script:
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE:latest

deploy:
  stage: deploy
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker-compose -f path/to/your/docker-compose.yml up -d
  only:
    - master  # You can specify when to deploy, e.g., only on the "master" branch
  dependencies:
    - build  # Ensure the "build" job completes before deploying

# build:
#   stage: build
#   script:
#     # - docker build -t angular-cicd-crud .
#     # - docker run -d -p 80:80 angular-cicd-crud
#     - docker build -t $CI_REGISTRY_IMAGE:latest .
#     - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
#     - docker push $CI_REGISTRY_IMAGE:latest

# variables:
#   SSH_PRIVATE_KEY: $SSH_PRIVATE_KEY  # Add a secret variable in GitLab for your SSH private key
#   SSH_USER: your-ssh-username
#   SSH_HOST: your-server-ip

# deploy:
#   stage: deploy
#   script:
#     - apk add --no-cache openssh-client  # Install SSH client (for Alpine Linux)
#     - eval $(ssh-agent -s)  # Start SSH agent
#     - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null  # Add SSH private key
#     - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts  # Add the host to known hosts
#     - ssh $SSH_USER@$SSH_HOST "docker pull your-docker-image:latest"  # Pull the latest Docker image
#     - ssh $SSH_USER@$SSH_HOST "docker stop your-container-name || true"  # Stop the existing container
#     - ssh $SSH_USER@$SSH_HOST "docker rm your-container-name || true"  # Remove the existing container
#     - ssh $SSH_USER@$SSH_HOST "docker run -d --name your-container-name -p 80:80 your-docker-image:latest"  # Run the new container